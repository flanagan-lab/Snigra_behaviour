---
title: "Chasing behaviour analysis"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,out.extra='',fig.pos="H",
                      fig.path = "./figs/",
                      dpi = 300,fig.keep='last',dev='png')
knitr::opts_knit$set(root.dir='../',fig_path="./figs/")
```

```{r loadLibs, message=FALSE}
library(stringr)
library(dplyr)
library(scales)
library(tidyverse)
require(lme4)
library(knitr)
```

```{r}
time_cols<-c(AM="#7fc97f",Noon="#beaed4")
trial_pch<-c(0:7,9:10)
```

This document is for the analysis of the *Stigmatopora nigra* chasing behaviours. During the mesocosm experiments, we noticed that male pipefish frequently 'chased' or followed a single female pipefish, interspersed with courting. 

Following an initial analysis of the courtship behaviours, Fleur van Eyndhoven re-analysed the videos to record chasing. Specifically, for each bout of courtship (which had been previously analysed), she recorded whether the bout ended in chasing, contained any chasing, and the size of the group (number of males and females). 

All of the raw data from this analysis is found in Chase_datasheets/. The code to parse the data is taken/modified from Fleur's script `R_scripts/Chasing_data.R`.



## Parsing the data

### Courtship data 

```{r readData}
courtfiles<-list.files(path="BORIS_data/",pattern="csv",full.names=TRUE)


courtdat<- lapply(courtfiles, function(file){           #no function so we just put file
  temp<-scan(file, "character", sep='\n', quiet = TRUE) #scan through data to line ending 
  nlines<- grep("Time,", temp)                      #fine line that starts with Time
  dat<-read.csv(file, skip=nlines-1) # skip everything above line that starts with Time
  dat$Modifier.3<-as.character(dat$Modifier.3) # Mod 3 has both numbers and words change to character
  dat$file.name<-file         ## add something in here to cut the path of file name so its just sample
  return(dat)
})   
courtdat<-bind_rows(courtdat)

```

```{r extractTimesFXN}
extract_times <- function(dat1){
  
  nn <- nrow(dat1)
  
  starting_points <- c()
  end_points <- c()
  
  #get where observations start
  for(i in 1:nn){
    d <- dat1[i,]
    
    behavior <- d$Behavior
    
    if(behavior == "Start"){
      #print("start")
      starting_points <- c(starting_points, i)
    }
    
    if(behavior == "Stop"){
      #print("end")
      end_points <- c(end_points, i)
    }
    
    
  }
  return(list(starting_points,end_points))
}
  
```

```{r extractTimes}
times<-extract_times(courtdat) 
starting_points<-times[[1]]
end_points<-times[[2]]
observation_chunks <- list()

 for(j in 1:length(starting_points) ){
    start <- starting_points[j]
    end <- end_points[j]
    observation_chunks[[j]] <- courtdat[start:end, ]
    
  }
```

```{r getUsefulInfo}
courtdat_list <- lapply(seq_along(observation_chunks), function(chunk){
  
  x <- observation_chunks[[chunk]]
  x$Modifier.1[is.na(x$Modifier.1)]<-""
  x$Modifier.2[is.na(x$Modifier.2)]<-""
  x$Modifier.3[is.na(x$Modifier.3)]<-""
  n3 <- nrow(x)
  
  length_of_chunk <- x$Time[n3] - x$Time[1] 
  times <-data.frame()
  
  for(k in 1:n3){
    x_row <- x[k,]
    
    if(x_row$Behavior== "Start" | x_row$Behavior== "Stop" ){
      next()
    }else{
      
      selected_behavior <- x_row$Behavior
      selected_subject <- x_row$Subject
      selected_m1 <- x_row$Modifier.1
      selected_m2 <- x_row$Modifier.2 
      selected_m3 <- x_row$Modifier.3
      selected_status <- x_row$Status
      
      if(selected_status=="START"){
        end_row <- x[which   (x$Behavior==selected_behavior &
                             x$Subject== selected_subject & 
                             x$Modifier.1 == selected_m1 &
                             x$Modifier.2 == selected_m2 &
                             x$Modifier.3 == selected_m3 &
                             x$Status == "STOP" &
                               x$Time>=x_row$Time),]
       
       
        time_elapsed <- end_row$Time[which.min(end_row$Time-x_row$Time)] - x_row$Time
        #}
        if(nrow(end_row)==0){
          print(paste(x_row$Media.file.path,x_row$Time,time_elapsed ))
        }
    
        return_data_per_row <- data.frame("media_file_path"= x_row$Media.file.path,
                                          "time_in_video"= x_row$Time,
                                          "Duration"= time_elapsed,
                                          "behavior"= selected_behavior,
                                          "subject"=selected_subject,
                                          "modifier_1" = selected_m1, 
                                          "modifier_2"= selected_m2,
                                          "modifier_3"= selected_m3)
        
        
        times <-rbind(times, return_data_per_row )
        
      }
      
      if(selected_status == "STOP"){
        next()
      }
      
      if(selected_status == "POINT"){
       
        return_data_per_row <- data.frame("media_file_path"= x_row$Media.file.path,
                                          "time_in_video"= x_row$Time,
                                          "Duration"= 0.00,
                                          "behavior"= selected_behavior,
                                          "subject"=selected_subject,
                                          "modifier_1" = selected_m1, 
                                          "modifier_2"= selected_m2,
                                          "modifier_3"= selected_m3)
        times <-rbind(times, return_data_per_row )
      }
    }
  }
  times$bout_number <- chunk
  times$total_time_of_courtship <- length_of_chunk
  
  return(times)  
})

court_data <- do.call(rbind, courtdat_list)
court_data$Trial=substr(court_data$media_file_path, 27, 33)
#Adding Am or Noon filming times
court_data$Time_of_Day=str_sub(court_data$media_file_path, -10)
court_data$Time_of_Day=str_extract(court_data$Time_of_Day,"(\\w+)")
court_data$Time_of_Day <-  ifelse(court_data$Time_of_Day == "oon", "Noon",
                                  court_data$Time_of_Day)
#Adding Date filmed 
court_data$Date_filmed=substr(court_data$media_file_path, 35, 42)
court_data$Date_filmed=str_extract(court_data$Date_filmed,"(\\w+)")

# Adding which day filmed (1-7)
court_data$Day_filmed <- ifelse(court_data$Trial == "Trial 1" & court_data$Date_filmed == 8, "7",
                                ifelse(court_data$Trial == "Trial 2" & court_data$Date_filmed == 3, "1",
                                       ifelse( court_data$Trial == "Trial 2" & court_data$Date_filmed == 9, "7",
                                               ifelse( court_data$Trial == "Trial 3" & court_data$Date_filmed == 3, "1",
                                                       ifelse( court_data$Trial == "Trial 3" & court_data$Date_filmed == 4, "2",
                                                               ifelse( court_data$Trial == "Trial 3" & court_data$Date_filmed == 5, "3",
                                                                       ifelse( court_data$Trial == "Trial 3" & court_data$Date_filmed == 8, "6",
                                                                               ifelse( court_data$Trial == "Trial 4" & court_data$Date_filmed == 4, "1",
                                                                                       ifelse( court_data$Trial == "Trial 4" & court_data$Date_filmed == 6, "3",
                                                                                               ifelse( court_data$Trial == "Trial 4" & court_data$Date_filmed == 7, "4",
                                                                                                       ifelse( court_data$Trial == "Trial 4" & court_data$Date_filmed == 10, "7",
                                                                                                               ifelse( court_data$Trial == "Trial 5" & court_data$Date_filmed == 6, "2",
                                                                                                                       ifelse( court_data$Trial == "Trial 5" & court_data$Date_filmed == 9, "5",
                                                                                                                               ifelse( court_data$Trial == "Trial 5" & court_data$Date_filmed == 10, "6",                    
                                                                                                                                       ifelse( court_data$Trial == "Trial 5" & court_data$Date_filmed == 11, "7",
                                                                                                                                               ifelse( court_data$Trial == "Trial 6" & court_data$Date_filmed == 7, "3",
                                                                                                                                                       ifelse( court_data$Trial == "Trial 6" & court_data$Date_filmed == 8, "4",
                                                                                                                                                               ifelse( court_data$Trial == "Trial 6" & court_data$Date_filmed == 10, "6",
                                                                                                                                                                       ifelse( court_data$Trial == "Trial 7" & court_data$Date_filmed == 10, "3",
                                                                                                                                                                               ifelse( court_data$Trial == "Trial 7" & court_data$Date_filmed == 13, "6",
                                                                                                                                                                                       ifelse( court_data$Trial == "Trial 8" & court_data$Date_filmed == 10, "3",
                                                                                                                                                                                               ifelse( court_data$Trial == "Trial 8" & court_data$Date_filmed == 11, "4",
                                                                                                                                                                                                       ifelse( court_data$Trial == "Trial 8" & court_data$Date_filmed == 13, "6",
                                                                                                                                                                                                               ifelse( court_data$Trial == "Trial 8" & court_data$Date_filmed == 14, "7",
                                                                                                                                                                                                                       ifelse( court_data$Trial == "Trial 9" & court_data$Date_filmed == 10, "2",
                                                                                                                                                                                                                               ifelse( court_data$Trial == "Trial 9" & court_data$Date_filmed == 11, "3",
                                                                                                                                                                                                                                       ifelse( court_data$Trial == "Trial 9" & court_data$Date_filmed == 13, "5",
                                                                                                                                                                                                                                               ifelse( court_data$Trial == "Trial 10" & court_data$Date_filmed == 12, "3",
                                                                                                                                                                                                                                                       NA  ))))))))))))))))))))))))))))

#Trial 10 
court_data$Trial <- ifelse(court_data$Trial == "Trial 1" & court_data$Date_filmed == 12, "Trial 10",
                           court_data$Trial)
court_data$Day_filmed <- ifelse( court_data$Trial == "Trial 10" & court_data$Date_filmed == 12, "3",
                                 court_data$Day_filmed)

  
```



### Chasing data

```{r getData}
chase_data<-dplyr::bind_rows(
  lapply(
    list.files(
      pattern="Trial", 
      path="Chase_datasheets",
      full.names = TRUE)
    , read.csv
    )
  )
colnames(chase_data) <- c("media_file_path", 
                          "time_in_video", 
                          "Duration",  
                          "behavior" , 
                          "subject" ,
                          "modifier_1" ,
                          "modifier_2",
                          "modifier_3" ,
                          "Group_size", 
                          "Female", 
                          "Male" ,
                          "Chasing_end" , 
                          "Chasing_present" , 
                          "bout_number_wrong" ,
                          "total_time_of_courtship")

```

```{r cleanData, warning=FALSE}
# remove extra columns
chase_data<-chase_data[,1:which(colnames(chase_data)=="total_time_of_courtship")]

# remove bouts with no active courtship
# aka female-female interactions where group size was NA
chase_data<- subset(chase_data,!is.na(Group_size)) 
chase_data <- chase_data %>%
  mutate_at(vars(Group_size,Female,Male), funs(round(., 1))) 

# remove column with incorrect bout numbers
chase_data <- chase_data[,-which(colnames(chase_data)=="bout_number_wrong")]
```

```{r metaData}
#Adding in Trial number
chase_data$Trial=substr(chase_data$media_file_path, 27, 33)
#Adding Am or Noon filming times
chase_data$Time_of_Day=str_sub(chase_data$media_file_path, -10)
chase_data$Time_of_Day=str_extract(chase_data$Time_of_Day,"(\\w+)")
chase_data$Time_of_Day <-  ifelse(chase_data$Time_of_Day == "oon", "Noon",
                                  chase_data$Time_of_Day)
#Adding Date filmed 
chase_data$Date_filmed=substr(chase_data$media_file_path, 35, 42)
chase_data$Date_filmed=str_extract(chase_data$Date_filmed,"(\\w+)")

# Adding which day filmed (1-7)
chase_data$Day_filmed <- ifelse(chase_data$Trial == "Trial 1" & chase_data$Date_filmed == 8, "7",
                         ifelse(chase_data$Trial == "Trial 2" & chase_data$Date_filmed == 3, "1",
                         ifelse( chase_data$Trial == "Trial 2" & chase_data$Date_filmed == 9, "7",
                         ifelse( chase_data$Trial == "Trial 3" & chase_data$Date_filmed == 3, "1",
                                                       ifelse( chase_data$Trial == "Trial 3" & chase_data$Date_filmed == 4, "2",
                                                               ifelse( chase_data$Trial == "Trial 3" & chase_data$Date_filmed == 5, "3",
                                                                       ifelse( chase_data$Trial == "Trial 3" & chase_data$Date_filmed == 8, "6",
                                                                               ifelse( chase_data$Trial == "Trial 4" & chase_data$Date_filmed == 4, "1",
                                                                                       ifelse( chase_data$Trial == "Trial 4" & chase_data$Date_filmed == 6, "3",
                                                                                               ifelse( chase_data$Trial == "Trial 4" & chase_data$Date_filmed == 7, "4",
                                                                                                       ifelse( chase_data$Trial == "Trial 4" & chase_data$Date_filmed == 10, "7",
                                                                                                               ifelse( chase_data$Trial == "Trial 5" & chase_data$Date_filmed == 6, "2",
                                                                                                                       ifelse( chase_data$Trial == "Trial 5" & chase_data$Date_filmed == 9, "5",
                                                                                                                               ifelse( chase_data$Trial == "Trial 5" & chase_data$Date_filmed == 10, "6",                    
                                                                                                                                       ifelse( chase_data$Trial == "Trial 5" & chase_data$Date_filmed == 11, "7",
                                                                                                                                               ifelse( chase_data$Trial == "Trial 6" & chase_data$Date_filmed == 7, "3",
                                                                                                                                                       ifelse( chase_data$Trial == "Trial 6" & chase_data$Date_filmed == 8, "4",
                                                                                                                                                               ifelse( chase_data$Trial == "Trial 6" & chase_data$Date_filmed == 10, "6",
                                                                                                                                                                       ifelse( chase_data$Trial == "Trial 7" & chase_data$Date_filmed == 10, "3",
                                                                                                                                                                               ifelse( chase_data$Trial == "Trial 7" & chase_data$Date_filmed == 13, "6",
                                                                                                                                                                                       ifelse( chase_data$Trial == "Trial 8" & chase_data$Date_filmed == 10, "3",
                                                                                                                                                                                               ifelse( chase_data$Trial == "Trial 8" & chase_data$Date_filmed == 11, "4",
                                                                                                                                                                                                       ifelse( chase_data$Trial == "Trial 8" & chase_data$Date_filmed == 13, "6",
                                                                                                                                                                                                               ifelse( chase_data$Trial == "Trial 8" & chase_data$Date_filmed == 14, "7",
                                                                                                                                                                                                                       ifelse( chase_data$Trial == "Trial 9" & chase_data$Date_filmed == 10, "2",
                                                                                                                                                                                                                               ifelse( chase_data$Trial == "Trial 9" & chase_data$Date_filmed == 11, "3",
                                                                                                                                                                                                                                       ifelse( chase_data$Trial == "Trial 9" & chase_data$Date_filmed == 13, "5",
                                                                                                                                                                                                                                               ifelse( chase_data$Trial == "Trial 10" & chase_data$Date_filmed == 12, "3",
                                                                                                                                                                                                                                                       NA  ))))))))))))))))))))))))))))

#Trial 10 - because R though it was trail 1
chase_data$Trial <- ifelse(chase_data$Trial == "Trial 1" & chase_data$Date_filmed == 12, "Trial 10",
                           chase_data$Trial)
chase_data$Day_filmed <- ifelse( chase_data$Trial == "Trial 10" & chase_data$Date_filmed == 12, "3",
                                 chase_data$Day_filmed)



```



```{r femaleSize}
chase_data <- chase_data %>% mutate(Max_length =
                     case_when(Trial =="Trial 1" ~ "115.2", 
                               Trial =="Trial 2" ~ "116.6",
                               Trial =="Trial 3" ~ "121.4",
                               Trial =="Trial 4" ~ "123.6",
                               Trial =="Trial 5" ~ "113.2",
                               Trial =="Trial 6" ~ "119.4",
                               Trial =="Trial 7" ~ "122.2",
                               Trial =="Trial 8" ~ "113.7",
                               Trial =="Trial 9" ~ "116.4",
                               Trial =="Trial 10"~ "113.5",                   
                               ))

chase_data <- chase_data %>% mutate(Min_length =
                               case_when(Trial =="Trial 1" ~ "87.8", 
                                         Trial =="Trial 2" ~ "89.8",
                                         Trial =="Trial 3" ~ "90.4",
                                         Trial =="Trial 4" ~ "86.8",
                                         Trial =="Trial 5" ~ "94.2",
                                         Trial =="Trial 6" ~ "83.2",
                                         Trial =="Trial 7" ~ "83.9",
                                         Trial =="Trial 8" ~ "88",
                                         Trial =="Trial 9" ~ "94.8",
                                         Trial =="Trial 10"~ "94.4",                   
                               ))

chase_data[ , c("Max_length","Min_length")]<- apply(chase_data[ , c("Max_length","Min_length")], 2,            
                    function(x) as.numeric(as.character(x)))
chase_data$Difference<- (chase_data$Max_length - chase_data$Min_length)

```
```{r chasingNum}
chase_data$Chasing_numeric<-ifelse(chase_data$Chasing_present=="Yes",1, 0)
chase_data$Chasing_end_numeric<-ifelse(chase_data$Chasing_end=="Yes",1, 0)
```

### Combining courtship and chasing data

```{r createUniqueID}
court_data$combo<-paste(gsub("\\s+","",court_data$media_file_path), 
                        court_data$time_in_video, 
                        round(court_data$Duration,3), 
                        round(court_data$total_time_of_courtship,3), sep="_")
court_data<-unique(court_data)

chase_data$combo<-paste(gsub("\\s+","",chase_data$media_file_path), 
                      chase_data$time_in_video, 
                      round(chase_data$Duration,3) ,
                      round(chase_data$total_time_of_courtship,3), sep="_")
chase_data<-unique(chase_data)
chase_data$Trial<-factor(chase_data$Trial,levels=c(
  "Trial 1",
  "Trial 2",
  "Trial 3",
  "Trial 4",
  "Trial 5",
  "Trial 6",
  "Trial 7",
  "Trial 8",
  "Trial 9",
  "Trial 10"
))

behav_data <- merge(court_data, chase_data[,c("combo","Group_size", "Female", "Male","Chasing_present","Chasing_numeric","Chasing_end","Chasing_end_numeric")], 
by="combo")
# remove any unnecessarily duplicated ones
behav_data<-unique(behav_data)

```

So, there are some interesting issues. There are fewer chasing observations than courtship observations, but this is expected -- chasing only occurred in intersexual contexts, and the courtship data contains some same-sex interactions. The courtship dataset also contains a few observations without active courtship from all participants, which were excluded from analyses.

But there are also some courtship bouts that are missing from the merged dataframe  -- let's take a look at these.

```{r checkingMissing}
missing<-court_data[!court_data$combo %in% behav_data$combo,]

intersex<-unlist(as.list(by(missing,missing$bout_number,function(bout){
  
  males<- bout$subject %in% "Male"
  
  if(length(males[males==TRUE]) == 0){
    return(FALSE)
  } else{
    return(TRUE)
  }
  
})))

# these are the bouts that should be included
#intersex[intersex==TRUE]
missing<-missing[missing$bout_number %in% names(intersex[intersex==TRUE]),]

active_behavs<-c("Wiggle","Pose")

active<-unlist(as.list(by(missing, missing$bout_number, function(bout, active_behavs){
  
  activeTF<-bout$behavior %in% active_behavs
  if(length(activeTF[activeTF==TRUE])==0){
    return(FALSE)
  }else {
    return(TRUE)
  }
},active_behavs=active_behavs)))
active_bouts<-active[active==TRUE]

missing<-missing[missing$bout_number %in% names(active_bouts),]
table(missing$media_file_path, missing$bout_number)
```

No courtship bouts remain that should be in the chase data but are not -- all courtship events involving both males and females and active behaviours are present.


```{r, eval=FALSE}
prob_file<-unique(chase_data$media_file_path[gsub("\\s+","",chase_data$media_file_path) %in% gsub("\\s+","",unique(missing$media_file_path))])

# number of observations in that trial
n_court<-nrow(court_data[gsub("\\s+","",court_data$media_file_path) %in% gsub("\\s+","",prob_file),])
n_chase<-nrow(chase_data[gsub("\\s+","",chase_data$media_file_path) %in% gsub("\\s+","",prob_file),])

prob_court<-court_data[gsub("\\s+","",court_data$media_file_path) %in% gsub("\\s+","",prob_file),]
prob_chase<-chase_data[gsub("\\s+","",chase_data$media_file_path) %in% gsub("\\s+","",prob_file),]

missing_times<-prob_court$time_in_video[!prob_court$time_in_video %in% prob_chase$time_in_video]
```

```{r, eval=FALSE}
hist(prob_chase$time_in_video[prob_chase$time_in_video >= min(missing_times) & prob_chase$time_in_video <= max(missing_times) ],
     col="grey",
     border = "grey",
     ylim=c(0,4),
     xlab="Time in the video",
     main="",
     ylab="Number of observations",
     breaks=seq(floor(min(missing_times))-5,ceiling(max(missing_times))+5,5))
hist(missing_times,add=TRUE, 
     col=alpha("cornflowerblue",0.5),
     border=alpha("cornflowerblue",0.5),
      breaks=seq(floor(min(missing_times))-5,ceiling(max(missing_times))+5,5))
legend("topleft",
       c("Timepoints in the chasing dataset",
         "Timepoints that are in the courting dataset 
and missing from chasing"),
       col=c("grey",alpha("cornflowerblue",0.5)),
       pch=15,
       bty='n',
       ncol=1)
```



## Analysis of chasing behaviours

Based on our time spent with the fish, we have a few questions we want to address:

* Was chasing more likely to occur in trials with larger females (and/or with larger differences in body size between smallest and largest females)? [this is a trial-level comparison]
* Is chasing more likely when there is a large number of individuals courting? [this is a courtship bout-level comparison]
* Are longer courtship bouts more likely to end in chasing and/or contain chasing? [this is a courtship bout-level comparison]


### Chasing and female size


```{r propChasingTrial}
# Calculating the proportion of chasing
prop_chasing <- table(chase_data$Trial, chase_data$Chasing_present )
prop_chasing <- as.data.frame(rbind(prop_chasing))
prop_chasing$No <- as.numeric(prop_chasing$No)
prop_chasing$Yes <- as.numeric(prop_chasing$Yes)
prop_chasing$sum <-prop_chasing$No + prop_chasing$Yes
prop_chasing$Prop_No <- round(prop_chasing$No/prop_chasing$sum, 3)
prop_chasing$Prop_Yes <- round(prop_chasing$Yes/prop_chasing$sum, 3)
prop_chasing$Trial <- rownames(prop_chasing)


prop_chase  <- merge(prop_chasing[,c(3:6)], 
                    unique(chase_data[,c("Trial", "Difference", "Max_length")]), 
                    by="Trial")

```

```{r plotPropChasingBodySize}
par(mfrow=c(1,2))
plot(prop_chase$Prop_Yes~prop_chase$Max_length,
     cex=log(prop_chase$sum)/2,
     pch=19,
     xlab="Maximum female length (mm)",
     ylab="Proportion of time spent chasing",
     bty='l',
     ylim=c(0,1),
     xlim=c(110,125))

plot(prop_chase$Prop_Yes~prop_chase$Difference,
     cex=log(prop_chase$sum)/2,
     pch=19,
     xlab="Difference in female lengths (mm)",
     ylab="Proportion of time spent chasing",
     bty='l',
     ylim=c(0,1),
     xlim=c(15,40))
```

```{r}
mod1<-glm(prop_chase$Prop_Yes ~ prop_chase$Max_length, family="binomial")
```



### Chasing and group size

```{r logitBackTransformFXN}
logit_back<-function(y) { return(exp(y)/(1+exp(y))) }

```
```{r}
predicted_probs<-function(mod, tmpdat,column, jvalues){
  # calculate predicted probabilities and store in a list
  pp <- lapply(jvalues, function(j) {
    
      tmpdat[,column] <- j
      p<-predict(mod, newdata = tmpdat, type = "response")
      
      return(p)
  })
  
  # get the means with lower and upper quartiles
  plotdat <- t(sapply(pp, function(x) {
    
      c(M = mean(x), quantile(x, c(0.2, 0.8)))
  }))
  
  # add in LengthofStay values and convert to data frame
  plotdat <- as.data.frame(cbind(plotdat, jvalues))
  
  # better names and show the first few rows
  colnames(plotdat) <- c("PredictedProbability", "Lower", "Upper", "Variable")
  
  return(plotdat)
}
```


```{r grpsizeChasingMod}
grpChaseMod<- glmer(Chasing_numeric~Group_size+Time_of_Day +(1|Trial), 
                    family="binomial",
                    data=chase_data)
grpChaseModSum<-summary(grpChaseMod)
anova(grpChaseMod)

# get standard errors
grpChaseMod_SE <- sqrt(diag(vcov(grpChaseMod)))

# convert to prob space
grpChaseMod_Est<-cbind(Est = logit_back(fixef(grpChaseMod)), 
              LL = logit_back(fixef(grpChaseMod) - 1.96 * se), 
              UL = logit_back(fixef(grpChaseMod) + 1.96 *se),
              grpChaseModSum$coefficients[,3:4])


kable(grpChaseMod_Est,"latex")
```

```{r grpChaseModPredict}
tmpdat <- chase_data[, c("Group_size", "Time_of_Day", "Trial")]
jvalues <- seq(from = min(chase_data$Group_size), to = max(chase_data$Group_size),length.out=100)

grpChaseMod_predict<-predicted_probs(grpChaseMod, tmpdat, "Group_size",jvalues)

```


```{r grpsizeEndMod}
grpEndMod<- glmer(Chasing_end_numeric~Group_size+Time_of_Day +(1|Trial), 
                    family="binomial",
                    data=chase_data)
grpEndModSum<-summary(grpEndMod)
anova(grpEndMod)

# get standard errors
grpEndMod_SE <- sqrt(diag(vcov(grpEndMod)))

# convert to prob space
grpEndMod_Est<-cbind(Est = logit_back(fixef(grpEndMod)), 
              LL = logit_back(fixef(grpEndMod) - 1.96 * se), 
              UL = logit_back(fixef(grpEndMod) + 1.96 *se),
              grpEndModSum$coefficients[,3:4])


kable(grpEndMod_Est,"latex")
```

```{r grpEndModPredict}
tmpdat <- chase_data[, c("Group_size", "Time_of_Day", "Trial")]
jvalues <- seq(from = min(chase_data$Group_size), to = max(chase_data$Group_size),length.out=100)

grpEndMod_predict<-predicted_probs(grpEndMod, tmpdat, "Group_size",jvalues)

```



```{r plotChaseGroups}
par(mfrow=c(1,2))
# chasing present/absent
plot(jitter(chase_data$Chasing_numeric, 0.25)~chase_data$Group_size,
       pch=trial_pch[chase_data$Trial],
     col=alpha(time_cols[chase_data$Time_of_Day],0.5),
     cex=1.5,
     xlab="Mean Group size",
     ylab="Chasing present",
     yaxt='n',
     bty='l',
     type='n')
axis(2,at=c(0,1),labels=c("No","Yes"),las=1)

# add the predicted probabilities
polygon(c(rev(grpChaseMod_predict$Variable),grpChaseMod_predict$Variable), 
        c(rev(grpChaseMod_predict$Lower),grpChaseMod_predict$Upper),
     col = alpha("grey90",0.5), border = NA)

lines(grpChaseMod_predict$Variable, 
      grpChaseMod_predict$PredictedProbability, lwd = 2)

# bout ended with chasing
plot(jitter(chase_data$Chasing_end_numeric,0.25)~chase_data$Group_size,
     xlab="Group size",
     ylab="Bout ended with Chasing",
     yaxt='n',
     bty='l',
     type='n',
     pch=trial_pch[chase_data$Trial],
     col=alpha(time_cols[chase_data$Time_of_Day],0.5),
     cex=1.5)
axis(2,at=c(0,1),labels=c("No","Yes"),las=1)


# add the predicted probabilities
polygon(c(rev(grpEndMod_predict$Variable),grpEndMod_predict$Variable), 
        c(rev(grpEndMod_predict$Lower),grpEndMod_predict$Upper),
     col = alpha("grey90",0.5), border = NA)

lines(grpEndMod_predict$Variable, 
      grpEndMod_predict$PredictedProbability, lwd = 2)


```

These plots made me curious: if a bout contained chasing, how frequently did it end with chasing? It looks like about 50% of the time. 

```{r chasingPresentEnd}
plot(table(chase_data$Chasing_present, chase_data$Chasing_end))
```






### Chasing and courtship bout length


```{r}
par(mfrow=c(2,2))
hist(chase_data$Group_size)
hist(chase_data$Duration)

hist(log(chase_data$Group_size))
hist(log(chase_data$Duration))
```


```{r durationChasingMod}
boutChaseMod<- glmer(Chasing_numeric~Duration+Time_of_Day +(1|Trial), 
                    family="binomial",
                    data=chase_data)
boutChaseModSum<-summary(boutChaseMod)
anova(boutChaseMod)

# get standard errors
boutChaseMod_SE <- sqrt(diag(vcov(boutChaseMod)))

# convert to prob space
boutChaseMod_Est<-cbind(Est = logit_back(fixef(boutChaseMod)), 
              LL = logit_back(fixef(boutChaseMod) - 1.96 * se), 
              UL = logit_back(fixef(boutChaseMod) + 1.96 *se),
              boutChaseModSum$coefficients[,3:4])


kable(boutChaseMod_Est,"latex")
```

```{r boutChaseModPredict}
tmpdat <- chase_data[, c("Duration", "Time_of_Day", "Trial")]
jvalues <- seq(from = min(chase_data$Duration), to = max(chase_data$Duration),length.out=100)

boutChaseMod_predict<-predicted_probs(boutChaseMod, tmpdat, "Duration",jvalues)

```


```{r boutsizeEndMod}
boutEndMod<- glmer(Chasing_end_numeric~Duration+Time_of_Day +(1|Trial), 
                    family="binomial",
                    data=chase_data)
boutEndModSum<-summary(boutEndMod)
anova(boutEndMod)

# get standard errors
boutEndMod_SE <- sqrt(diag(vcov(boutEndMod)))

# convert to prob space
boutEndMod_Est<-cbind(Est = logit_back(fixef(boutEndMod)), 
              LL = logit_back(fixef(boutEndMod) - 1.96 * se), 
              UL = logit_back(fixef(boutEndMod) + 1.96 *se),
              boutEndModSum$coefficients[,3:4])


kable(boutEndMod_Est,"latex")
```

```{r boutEndModPredict}
tmpdat <- chase_data[, c("Duration", "Time_of_Day", "Trial")]
jvalues <- seq(from = min(chase_data$Duration), to = max(chase_data$Duration),length.out=100)

boutEndMod_predict<-predicted_probs(boutEndMod, tmpdat, "Duration",jvalues)

```



```{r plotChaseBoutLength}

par(mfrow=c(1,2))
# chasing present/absent
plot(jitter(chase_data$Chasing_numeric)~chase_data$Duration,
     xlab="Courtship bout duration (s)",
     ylab="Chasing present",
     yaxt='n',
     bty='l',
     pch=19,
     col=alpha("dark grey",0.5),
     cex=1.5,
     type='n')
axis(2,at=c(1,2),labels=c("No","Yes"),las=1)


# add the predicted probabilities
polygon(c(rev(boutChaseMod_predict$Variable),boutChaseMod_predict$Variable), 
        c(rev(boutChaseMod_predict$Lower),boutChaseMod_predict$Upper),
     col = alpha("grey90",0.5), border = NA)

lines(boutChaseMod_predict$Variable, 
      boutChaseMod_predict$PredictedProbability, lwd = 2)

# add the points
points(jitter(chase_data$Chasing_numeric, 0.5)~chase_data$Duration,
       pch=trial_pch[chase_data$Trial],
     col=alpha(time_cols[chase_data$Time_of_Day],0.5),
     cex=1.5)


# bout ended with chasing
plot(jitter(chase_data$Chasing_end_numeric)~chase_data$Duration,
     xlab="Courtship bout duration (s)",
     ylab="Bout ended with Chasing",
     yaxt='n',
     bty='l',
     pch=19,
     col=alpha("dark grey",0.5),
     cex=1.5,
     type='n')
axis(2,at=c(1,2),labels=c("No","Yes"),las=1)

# add the predicted probabilities
polygon(c(rev(boutEndMod_predict$Variable),boutEndMod_predict$Variable), 
        c(rev(boutEndMod_predict$Lower),boutEndMod_predict$Upper),
     col = alpha("grey90",0.5), border = NA)

lines(boutEndMod_predict$Variable, 
      boutEndMod_predict$PredictedProbability, lwd = 2)

# add the points
points(jitter(chase_data$Chasing_numeric, 0.5)~chase_data$Duration,
       pch=trial_pch[chase_data$Trial],
     col=alpha(time_cols[chase_data$Time_of_Day],0.5),
     cex=1.5)

```


