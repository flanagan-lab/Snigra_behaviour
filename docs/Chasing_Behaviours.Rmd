---
title: "Chasing behaviour analysis"
output: 
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: no
    toc: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,out.extra='',fig.pos="H",
                      fig.path = "./figs/",
                      dpi = 300,fig.keep='last',dev='png')
knitr::opts_knit$set(root.dir='../',fig_path="./figs/")
```

```{r loadLibs, message=FALSE}
library(stringr)
library(dplyr)
library(scales)
library(tidyverse)
require(lme4)
library(knitr)
```

```{r}
time_cols<-c(AM="#7fc97f",Noon="#beaed4")
trial_pch<-c(0:7,9:10)
```
```{r}
logit_transform<-function(x){
  xl<-log(x/(1-x))
  return(xl)
}
```

 
This document is for the analysis of the *Stigmatopora nigra* chasing behaviours. During the mesocosm experiments, we noticed that male pipefish frequently 'chased' or followed a single female pipefish, interspersed with courting. 

Following an initial analysis of the courtship behaviours, Fleur van Eyndhoven re-analysed the videos to record chasing. Specifically, for each bout of courtship (which had been previously analysed), she recorded whether the bout ended in chasing, contained any chasing, and the size of the group (number of males and females). 

All of the raw data from this analysis is found in Chase_datasheets/. The code to parse the data is taken/modified from Fleur's script `R_scripts/Chasing_data.R`.



## Parsing the data

### Courtship data 

```{r readData}
courtfiles<-list.files(path="BORIS_data/",pattern="csv",full.names=TRUE)


courtdat<- lapply(courtfiles, function(file){           #no function so we just put file
  temp<-scan(file, "character", sep='\n', quiet = TRUE) #scan through data to line ending 
  nlines<- grep("Time,", temp)                      #fine line that starts with Time
  dat<-read.csv(file, skip=nlines-1) # skip everything above line that starts with Time
  dat$Modifier.3<-as.character(dat$Modifier.3) # Mod 3 has both numbers and words change to character
  dat$file.name<-file         ## add something in here to cut the path of file name so its just sample
  return(dat)
})   
courtdat<-bind_rows(courtdat)

```

```{r extractTimesFXN}
extract_times <- function(dat1){
  
  nn <- nrow(dat1)
  
  starting_points <- c()
  end_points <- c()
  
  #get where observations start
  for(i in 1:nn){
    d <- dat1[i,]
    
    behavior <- d$Behavior
    
    if(behavior == "Start"){
      #print("start")
      starting_points <- c(starting_points, i)
    }
    
    if(behavior == "Stop"){
      #print("end")
      end_points <- c(end_points, i)
    }
    
    
  }
  return(list(starting_points,end_points))
}
  
```

```{r extractTimes}
times<-extract_times(courtdat) 
starting_points<-times[[1]]
end_points<-times[[2]]
observation_chunks <- list()

 for(j in 1:length(starting_points) ){
    start <- starting_points[j]
    end <- end_points[j]
    observation_chunks[[j]] <- courtdat[start:end, ]
    
  }
```

```{r getUsefulInfo}
courtdat_list <- lapply(seq_along(observation_chunks), function(chunk){
  
  x <- observation_chunks[[chunk]]
  x$Modifier.1[is.na(x$Modifier.1)]<-""
  x$Modifier.2[is.na(x$Modifier.2)]<-""
  x$Modifier.3[is.na(x$Modifier.3)]<-""
  n3 <- nrow(x)
  
  length_of_chunk <- x$Time[n3] - x$Time[1] 
  times <-data.frame()
  
  for(k in 1:n3){
    x_row <- x[k,]
    
    if(x_row$Behavior== "Start" | x_row$Behavior== "Stop" ){
      next()
    }else{
      
      selected_behavior <- x_row$Behavior
      selected_subject <- x_row$Subject
      selected_m1 <- x_row$Modifier.1
      selected_m2 <- x_row$Modifier.2 
      selected_m3 <- x_row$Modifier.3
      selected_status <- x_row$Status
      
      if(selected_status=="START"){
        end_row <- x[which   (x$Behavior==selected_behavior &
                             x$Subject== selected_subject & 
                             x$Modifier.1 == selected_m1 &
                             x$Modifier.2 == selected_m2 &
                             x$Modifier.3 == selected_m3 &
                             x$Status == "STOP" &
                               x$Time>=x_row$Time),]
       
       
        time_elapsed <- end_row$Time[which.min(end_row$Time-x_row$Time)] - x_row$Time
        #}
        if(nrow(end_row)==0){
          print(paste(x_row$Media.file.path,x_row$Time,time_elapsed ))
        }
    
        return_data_per_row <- data.frame("media_file_path"= x_row$Media.file.path,
                                          "time_in_video"= x_row$Time,
                                          "Duration"= time_elapsed,
                                          "behavior"= selected_behavior,
                                          "subject"=selected_subject,
                                          "modifier_1" = selected_m1, 
                                          "modifier_2"= selected_m2,
                                          "modifier_3"= selected_m3)
        
        
        times <-rbind(times, return_data_per_row )
        
      }
      
      if(selected_status == "STOP"){
        next()
      }
      
      if(selected_status == "POINT"){
       
        return_data_per_row <- data.frame("media_file_path"= x_row$Media.file.path,
                                          "time_in_video"= x_row$Time,
                                          "Duration"= 0.00,
                                          "behavior"= selected_behavior,
                                          "subject"=selected_subject,
                                          "modifier_1" = selected_m1, 
                                          "modifier_2"= selected_m2,
                                          "modifier_3"= selected_m3)
        times <-rbind(times, return_data_per_row )
      }
    }
  }
  times$bout_number <- chunk
  times$total_time_of_courtship <- length_of_chunk
  
  return(times)  
})

court_data <- do.call(rbind, courtdat_list)
court_data$Trial=substr(court_data$media_file_path, 27, 33)
#Adding Am or Noon filming times
court_data$Time_of_Day=str_sub(court_data$media_file_path, -10)
court_data$Time_of_Day=str_extract(court_data$Time_of_Day,"(\\w+)")
court_data$Time_of_Day <-  ifelse(court_data$Time_of_Day == "oon", "Noon",
                                  court_data$Time_of_Day)
#Adding Date filmed 
court_data$Date_filmed=substr(court_data$media_file_path, 35, 42)
court_data$Date_filmed=str_extract(court_data$Date_filmed,"(\\w+)")

# Adding which day filmed (1-7)
court_data$Day_filmed <- ifelse(court_data$Trial == "Trial 1" & court_data$Date_filmed == 8, "7",
                                ifelse(court_data$Trial == "Trial 2" & court_data$Date_filmed == 3, "1",
                                       ifelse( court_data$Trial == "Trial 2" & court_data$Date_filmed == 9, "7",
                                               ifelse( court_data$Trial == "Trial 3" & court_data$Date_filmed == 3, "1",
                                                       ifelse( court_data$Trial == "Trial 3" & court_data$Date_filmed == 4, "2",
                                                               ifelse( court_data$Trial == "Trial 3" & court_data$Date_filmed == 5, "3",
                                                                       ifelse( court_data$Trial == "Trial 3" & court_data$Date_filmed == 8, "6",
                                                                               ifelse( court_data$Trial == "Trial 4" & court_data$Date_filmed == 4, "1",
                                                                                       ifelse( court_data$Trial == "Trial 4" & court_data$Date_filmed == 6, "3",
                                                                                               ifelse( court_data$Trial == "Trial 4" & court_data$Date_filmed == 7, "4",
                                                                                                       ifelse( court_data$Trial == "Trial 4" & court_data$Date_filmed == 10, "7",
                                                                                                               ifelse( court_data$Trial == "Trial 5" & court_data$Date_filmed == 6, "2",
                                                                                                                       ifelse( court_data$Trial == "Trial 5" & court_data$Date_filmed == 9, "5",
                                                                                                                               ifelse( court_data$Trial == "Trial 5" & court_data$Date_filmed == 10, "6",                    
                                                                                                                                       ifelse( court_data$Trial == "Trial 5" & court_data$Date_filmed == 11, "7",
                                                                                                                                               ifelse( court_data$Trial == "Trial 6" & court_data$Date_filmed == 7, "3",
                                                                                                                                                       ifelse( court_data$Trial == "Trial 6" & court_data$Date_filmed == 8, "4",
                                                                                                                                                               ifelse( court_data$Trial == "Trial 6" & court_data$Date_filmed == 10, "6",
                                                                                                                                                                       ifelse( court_data$Trial == "Trial 7" & court_data$Date_filmed == 10, "3",
                                                                                                                                                                               ifelse( court_data$Trial == "Trial 7" & court_data$Date_filmed == 13, "6",
                                                                                                                                                                                       ifelse( court_data$Trial == "Trial 8" & court_data$Date_filmed == 10, "3",
                                                                                                                                                                                               ifelse( court_data$Trial == "Trial 8" & court_data$Date_filmed == 11, "4",
                                                                                                                                                                                                       ifelse( court_data$Trial == "Trial 8" & court_data$Date_filmed == 13, "6",
                                                                                                                                                                                                               ifelse( court_data$Trial == "Trial 8" & court_data$Date_filmed == 14, "7",
                                                                                                                                                                                                                       ifelse( court_data$Trial == "Trial 9" & court_data$Date_filmed == 10, "2",
                                                                                                                                                                                                                               ifelse( court_data$Trial == "Trial 9" & court_data$Date_filmed == 11, "3",
                                                                                                                                                                                                                                       ifelse( court_data$Trial == "Trial 9" & court_data$Date_filmed == 13, "5",
                                                                                                                                                                                                                                               ifelse( court_data$Trial == "Trial 10" & court_data$Date_filmed == 12, "3",
                                                                                                                                                                                                                                                       NA  ))))))))))))))))))))))))))))

#Trial 10 
court_data$Trial <- ifelse(court_data$Trial == "Trial 1" & court_data$Date_filmed == 12, "Trial 10",
                           court_data$Trial)
court_data$Day_filmed <- ifelse( court_data$Trial == "Trial 10" & court_data$Date_filmed == 12, "3",
                                 court_data$Day_filmed)

  
```



### Chasing data

```{r getData}
chase_data<-dplyr::bind_rows(
  lapply(
    list.files(
      pattern="Trial", 
      path="Chase_datasheets",
      full.names = TRUE)
    , read.csv
    )
  )
colnames(chase_data) <- c("media_file_path", 
                          "time_in_video", 
                          "Duration",  
                          "behavior" , 
                          "subject" ,
                          "modifier_1" ,
                          "modifier_2",
                          "modifier_3" ,
                          "Group_size", 
                          "Female", 
                          "Male" ,
                          "Chasing_end" , 
                          "Chasing_present" , 
                          "bout_number_wrong" ,
                          "total_time_of_courtship")

```

```{r cleanData, warning=FALSE}
# remove extra columns
chase_data<-chase_data[,1:which(colnames(chase_data)=="total_time_of_courtship")]

# remove bouts with no active courtship
# aka female-female interactions where group size was NA
chase_data<- subset(chase_data,!is.na(Group_size)) 
chase_data <- chase_data %>%
  mutate_at(vars(Group_size,Female,Male), funs(round(., 1))) 

# remove column with incorrect bout numbers
chase_data <- chase_data[,-which(colnames(chase_data)=="bout_number_wrong")]
```

```{r metaData}
#Adding in Trial number
chase_data$Trial=substr(chase_data$media_file_path, 27, 33)
#Adding Am or Noon filming times
chase_data$Time_of_Day=str_sub(chase_data$media_file_path, -10)
chase_data$Time_of_Day=str_extract(chase_data$Time_of_Day,"(\\w+)")
chase_data$Time_of_Day <-  ifelse(chase_data$Time_of_Day == "oon", "Noon",
                                  chase_data$Time_of_Day)
#Adding Date filmed 
chase_data$Date_filmed=substr(chase_data$media_file_path, 35, 42)
chase_data$Date_filmed=str_extract(chase_data$Date_filmed,"(\\w+)")

# Adding which day filmed (1-7)
chase_data$Day_filmed <- ifelse(chase_data$Trial == "Trial 1" & chase_data$Date_filmed == 8, "7",
                         ifelse(chase_data$Trial == "Trial 2" & chase_data$Date_filmed == 3, "1",
                         ifelse( chase_data$Trial == "Trial 2" & chase_data$Date_filmed == 9, "7",
                         ifelse( chase_data$Trial == "Trial 3" & chase_data$Date_filmed == 3, "1",
                                                       ifelse( chase_data$Trial == "Trial 3" & chase_data$Date_filmed == 4, "2",
                                                               ifelse( chase_data$Trial == "Trial 3" & chase_data$Date_filmed == 5, "3",
                                                                       ifelse( chase_data$Trial == "Trial 3" & chase_data$Date_filmed == 8, "6",
                                                                               ifelse( chase_data$Trial == "Trial 4" & chase_data$Date_filmed == 4, "1",
                                                                                       ifelse( chase_data$Trial == "Trial 4" & chase_data$Date_filmed == 6, "3",
                                                                                               ifelse( chase_data$Trial == "Trial 4" & chase_data$Date_filmed == 7, "4",
                                                                                                       ifelse( chase_data$Trial == "Trial 4" & chase_data$Date_filmed == 10, "7",
                                                                                                               ifelse( chase_data$Trial == "Trial 5" & chase_data$Date_filmed == 6, "2",
                                                                                                                       ifelse( chase_data$Trial == "Trial 5" & chase_data$Date_filmed == 9, "5",
                                                                                                                               ifelse( chase_data$Trial == "Trial 5" & chase_data$Date_filmed == 10, "6",                    
                                                                                                                                       ifelse( chase_data$Trial == "Trial 5" & chase_data$Date_filmed == 11, "7",
                                                                                                                                               ifelse( chase_data$Trial == "Trial 6" & chase_data$Date_filmed == 7, "3",
                                                                                                                                                       ifelse( chase_data$Trial == "Trial 6" & chase_data$Date_filmed == 8, "4",
                                                                                                                                                               ifelse( chase_data$Trial == "Trial 6" & chase_data$Date_filmed == 10, "6",
                                                                                                                                                                       ifelse( chase_data$Trial == "Trial 7" & chase_data$Date_filmed == 10, "3",
                                                                                                                                                                               ifelse( chase_data$Trial == "Trial 7" & chase_data$Date_filmed == 13, "6",
                                                                                                                                                                                       ifelse( chase_data$Trial == "Trial 8" & chase_data$Date_filmed == 10, "3",
                                                                                                                                                                                               ifelse( chase_data$Trial == "Trial 8" & chase_data$Date_filmed == 11, "4",
                                                                                                                                                                                                       ifelse( chase_data$Trial == "Trial 8" & chase_data$Date_filmed == 13, "6",
                                                                                                                                                                                                               ifelse( chase_data$Trial == "Trial 8" & chase_data$Date_filmed == 14, "7",
                                                                                                                                                                                                                       ifelse( chase_data$Trial == "Trial 9" & chase_data$Date_filmed == 10, "2",
                                                                                                                                                                                                                               ifelse( chase_data$Trial == "Trial 9" & chase_data$Date_filmed == 11, "3",
                                                                                                                                                                                                                                       ifelse( chase_data$Trial == "Trial 9" & chase_data$Date_filmed == 13, "5",
                                                                                                                                                                                                                                               ifelse( chase_data$Trial == "Trial 10" & chase_data$Date_filmed == 12, "3",
                                                                                                                                                                                                                                                       NA  ))))))))))))))))))))))))))))

#Trial 10 - because R though it was trail 1
chase_data$Trial <- ifelse(chase_data$Trial == "Trial 1" & chase_data$Date_filmed == 12, "Trial 10",
                           chase_data$Trial)
chase_data$Day_filmed <- ifelse( chase_data$Trial == "Trial 10" & chase_data$Date_filmed == 12, "3",
                                 chase_data$Day_filmed)



```



```{r femaleSize}
chase_data <- chase_data %>% mutate(Max_length =
                     case_when(Trial =="Trial 1" ~ "115.2", 
                               Trial =="Trial 2" ~ "116.6",
                               Trial =="Trial 3" ~ "121.4",
                               Trial =="Trial 4" ~ "123.6",
                               Trial =="Trial 5" ~ "113.2",
                               Trial =="Trial 6" ~ "119.4",
                               Trial =="Trial 7" ~ "122.2",
                               Trial =="Trial 8" ~ "113.7",
                               Trial =="Trial 9" ~ "116.4",
                               Trial =="Trial 10"~ "113.5",                   
                               ))

chase_data <- chase_data %>% mutate(Min_length =
                               case_when(Trial =="Trial 1" ~ "87.8", 
                                         Trial =="Trial 2" ~ "89.8",
                                         Trial =="Trial 3" ~ "90.4",
                                         Trial =="Trial 4" ~ "86.8",
                                         Trial =="Trial 5" ~ "94.2",
                                         Trial =="Trial 6" ~ "83.2",
                                         Trial =="Trial 7" ~ "83.9",
                                         Trial =="Trial 8" ~ "88",
                                         Trial =="Trial 9" ~ "94.8",
                                         Trial =="Trial 10"~ "94.4",                   
                               ))

chase_data[ , c("Max_length","Min_length")]<- apply(chase_data[ , c("Max_length","Min_length")], 2,            
                    function(x) as.numeric(as.character(x)))
chase_data$Difference<- (chase_data$Max_length - chase_data$Min_length)

```
```{r chasingNum}
chase_data$Chasing_numeric<-ifelse(chase_data$Chasing_present=="Yes",1, 0)
chase_data$Chasing_end_numeric<-ifelse(chase_data$Chasing_end=="Yes",1, 0)
```

### Combining courtship and chasing data

```{r createUniqueID}
court_data$combo<-paste(gsub("\\s+","",court_data$media_file_path), 
                        court_data$time_in_video, 
                        round(court_data$Duration,3), 
                        round(court_data$total_time_of_courtship,3), sep="_")
court_data<-unique(court_data)

chase_data$combo<-paste(gsub("\\s+","",chase_data$media_file_path), 
                      chase_data$time_in_video, 
                      round(chase_data$Duration,3) ,
                      round(chase_data$total_time_of_courtship,3), sep="_")
chase_data<-unique(chase_data)
chase_data$Trial<-factor(chase_data$Trial,levels=c(
  "Trial 1",
  "Trial 2",
  "Trial 3",
  "Trial 4",
  "Trial 5",
  "Trial 6",
  "Trial 7",
  "Trial 8",
  "Trial 9",
  "Trial 10"
))

behav_data <- merge(court_data, chase_data[,c("combo","Group_size", "Female", "Male","Chasing_present","Chasing_numeric","Chasing_end","Chasing_end_numeric")], 
by="combo")
# remove any unnecessarily duplicated ones
behav_data<-unique(behav_data)

```

So, there are some interesting issues. There are fewer chasing observations than courtship observations, but this is expected -- chasing only occurred in intersexual contexts, and the courtship data contains some same-sex interactions. The courtship dataset also contains a few observations without active courtship from all participants, which were excluded from analyses.

But there are also some courtship bouts that are missing from the merged dataframe  -- let's take a look at these.

```{r checkingMissing}
missing<-court_data[!court_data$combo %in% behav_data$combo,]

intersex<-unlist(as.list(by(missing,missing$bout_number,function(bout){
  
  males<- bout$subject %in% "Male"
  
  if(length(males[males==TRUE]) == 0){
    return(FALSE)
  } else{
    return(TRUE)
  }
  
})))

# these are the bouts that should be included
#intersex[intersex==TRUE]
missing<-missing[missing$bout_number %in% names(intersex[intersex==TRUE]),]

active_behavs<-c("Wiggle","Pose")

active<-unlist(as.list(by(missing, missing$bout_number, function(bout, active_behavs){
  
  activeTF<-bout$behavior %in% active_behavs
  if(length(activeTF[activeTF==TRUE])==0){
    return(FALSE)
  }else {
    return(TRUE)
  }
},active_behavs=active_behavs)))
active_bouts<-active[active==TRUE]

missing<-missing[missing$bout_number %in% names(active_bouts),]
table(missing$media_file_path, missing$bout_number)
```

No courtship bouts remain that should be in the chase data but are not -- all courtship events involving both males and females and active behaviours are present.


```{r, eval=FALSE}
prob_file<-unique(chase_data$media_file_path[gsub("\\s+","",chase_data$media_file_path) %in% gsub("\\s+","",unique(missing$media_file_path))])

# number of observations in that trial
n_court<-nrow(court_data[gsub("\\s+","",court_data$media_file_path) %in% gsub("\\s+","",prob_file),])
n_chase<-nrow(chase_data[gsub("\\s+","",chase_data$media_file_path) %in% gsub("\\s+","",prob_file),])

prob_court<-court_data[gsub("\\s+","",court_data$media_file_path) %in% gsub("\\s+","",prob_file),]
prob_chase<-chase_data[gsub("\\s+","",chase_data$media_file_path) %in% gsub("\\s+","",prob_file),]

missing_times<-prob_court$time_in_video[!prob_court$time_in_video %in% prob_chase$time_in_video]
```

```{r, eval=FALSE}
hist(prob_chase$time_in_video[prob_chase$time_in_video >= min(missing_times) & prob_chase$time_in_video <= max(missing_times) ],
     col="grey",
     border = "grey",
     ylim=c(0,4),
     xlab="Time in the video",
     main="",
     ylab="Number of observations",
     breaks=seq(floor(min(missing_times))-5,ceiling(max(missing_times))+5,5))
hist(missing_times,add=TRUE, 
     col=alpha("cornflowerblue",0.5),
     border=alpha("cornflowerblue",0.5),
      breaks=seq(floor(min(missing_times))-5,ceiling(max(missing_times))+5,5))
legend("topleft",
       c("Timepoints in the chasing dataset",
         "Timepoints that are in the courting dataset 
and missing from chasing"),
       col=c("grey",alpha("cornflowerblue",0.5)),
       pch=15,
       bty='n',
       ncol=1)
```



## Analysis of chasing behaviours

Based on our time spent with the fish, we have a few questions we want to address:

* Was chasing more likely to occur in trials with larger females (and/or with larger differences in body size between smallest and largest females)? [this is a trial-level comparison]
* Is chasing more likely when there is a large number of individuals courting? [this is a courtship bout-level comparison]
* Are longer courtship bouts more likely to end in chasing and/or contain chasing? [this is a courtship bout-level comparison]

### Exploratory analysis


First I need to convert the data from a per-observation basis to a per-bout basis. What I need for the analysis are the bout number, the information in `total_time_of_courtship`, the group size, chasing info, the trial number, and the time of day. 

```{r}
bout_data<-do.call(rbind,as.list(by(
  data=behav_data,
  INDICES=behav_data$bout_number,
  function(dat){
    bout_dat<- dat[,c("bout_number","Trial", "Time_of_Day","Group_size", "total_time_of_courtship","Chasing_present","Chasing_numeric","Chasing_end","Chasing_end_numeric")]
    return(unique(bout_dat))
  }
  
)))
```

Then I'll visualize the data for the two main effects of interest (group size and bout duration) to evaluate if transformation is needed or helpful. It looks like transforming the bout duration will be helpful (Fig. \@ref(fig:yvalsHist))

```{r yvalsHist, fig.cap="Distributions of the variables for group size and bout duration before (top row) and after (bottom row) log-transformation."}
par(mfrow=c(2,2))
hist(bout_data$Group_size, 
     main="",
     xlab="Group size",
     ylab="Number of bouts"
     )
hist(bout_data$total_time_of_courtship,
     main="",
     xlab="Duration (s)",
     ylab="Number of bouts")

hist(log(bout_data$Group_size),
     main="",
     xlab="log(Group size)",
     ylab="Number of bouts")
hist(log(bout_data$total_time_of_courtship),
     main="",
     xlab="log(Duration)",
     ylab="Number of bouts")
```

Another interesting component is to evaluate if a bout contained chasing, how frequently did it end with chasing? We can see most bouts did not contain chasing, and a large number of those that did contain chasing did not end in chasing (Fig. \@ref(fig:chasingPresentEnd)). To some extent, this result is tautological, in that bouts that did not contain chasing had no way of ending in chasing.

```{r chasingPresentEnd, fig.cap="The occurrence of bouts ending in chasing, given that they contained chasing.", fig.height=5, fig.width=5}
plot(table(chase_data$Chasing_present, chase_data$Chasing_end),
     main="")
mtext("The bout ended in chasing",2)
mtext("The bout contained chasing",3)
```

Before fitting models, we also want to check if:
- the variances of data (transformed by the link function) are homogeneous across categories
- the responses of transformed data linear with respect to continuous predictors? 
- outlier individuals or groups exist
- whether distributions within groups match the assumed distribution


```{r variancesPlot}
par(mfrow=c(2,2))
plot(bout_data$Chasing_numeric~bout_data$Group_size)
plot(bout_data$Chasing_numeric~bout_data$logDuration)
plot(bout_data$Chasing_numeric~bout_data$Time_of_Day)
plot(bout_data$Chasing_numeric~bout_data$Trial)
```

```{r variancesPlotFlipped}
par(mfrow=c(2,2))
plot(bout_data$Group_size~bout_data$Chasing_numeric)
plot(bout_data$logDuration~bout_data$Chasing_numeric)
plot(bout_data$Time_of_Day~bout_data$Chasing_numeric)
plot(bout_data$Trial~bout_data$Chasing_numeric)
```

So these boxplots are not great -- logDuration looks good, and the group size is ok except for trials 9 and 10, but time of day is a bit all over the place. 

```{r}
par(mfrow=c(2,2))
boxplot(bout_data$Group_size~bout_data$Time_of_Day)
boxplot(bout_data$logDuration~bout_data$Time_of_Day)
boxplot(bout_data$Group_size~bout_data$Trial)
boxplot(bout_data$logDuration~bout_data$Trial)
```

```{r}
plot(bout_data$Group_size~bout_data$logDuration)
```

These plots suggest that I'm probably ok to move forward with these data, but I might consider dropping the observations from Trial 10 and seeing if the model output is different.

### Chasing, group size, bout duration

We can analyse the chasing behaviours within each bout as a function of the overall group size and bout duration, with time of day as a predictor variable and the trial as a random effect.

```{r logitBackTransformFXN}
logit_back<-function(y) { return(exp(y)/(1+exp(y))) }

```
```{r}
predicted_probs<-function(mod, tmpdat,column, jvalues){
  # calculate predicted probabilities and store in a list
  pp <- lapply(jvalues, function(j) {
    
      tmpdat[,column] <- j
      p<-predict(mod, newdata = tmpdat, type = "response")
      
      return(p)
  })
  
  # get the means with lower and upper quartiles
  plotdat <- t(sapply(pp, function(x) {
    
      c(M = mean(x), quantile(x, c(0.2, 0.8)))
  }))
  
  # add in LengthofStay values and convert to data frame
  plotdat <- as.data.frame(cbind(plotdat, jvalues))
  
  # better names and show the first few rows
  colnames(plotdat) <- c("PredictedProbability", "Lower", "Upper", "Variable")
  
  return(plotdat)
}
```

```{r}
bout_data$logDuration<-log(bout_data$total_time_of_courtship)
bout_data$Time_of_Day <- factor(bout_data$Time_of_Day,
                                levels=c("AM","Noon"))
bout_data$Trial <- factor(bout_data$Trial,
                          levels=c(
  "Trial 1",
  "Trial 2",
  "Trial 3",
  "Trial 4",
  "Trial 5",
  "Trial 6",
  "Trial 7",
  "Trial 8",
  "Trial 9",
  "Trial 10"
))
```

```{r ChasingMod}
ChaseMod<- glmer(Chasing_numeric~Group_size*logDuration+ (1|Time_of_Day) +(1|Trial), 
                    family="binomial",
                    data=bout_data)
ChaseModSum<-summary(ChaseMod)
ChaseModANOVA<-anova(ChaseMod)

# get standard errors
ChaseMod_SE <- sqrt(diag(vcov(ChaseMod)))

# convert to prob space
ChaseMod_Est<-cbind(Est = logit_back(fixef(ChaseMod)), 
              LL = logit_back(fixef(ChaseMod) - 1.96 * ChaseMod_SE ), 
              UL = logit_back(fixef(ChaseMod) + 1.96 *ChaseMod_SE ),
              ChaseModSum$coefficients[,3:4])


kable(ChaseMod_Est,"latex",booktab=TRUE)
```

All of the fixed effects in the model were significant (Table \@ref(tab:ChasingMod)), with group size, bout duration, and time of day increasing the probability of chasing occurring (once the variance associated with the trial was partitioned out).

I then created predicted probabilities based on the model to summarize the overall effect. 

```{r ChaseModPredict}
tmpdat <- bout_data[, c("Group_size","logDuration", "Time_of_Day", "Trial")]

# Group size
jvalues <- seq(from = min(bout_data$Group_size), to = max(bout_data$Group_size),length.out=100)
ChaseMod_predict<-predicted_probs(ChaseMod, tmpdat, "Group_size",jvalues)

# duration (log-transformed)
jvalues <- seq(from = min(bout_data$logDuration), to = max(bout_data$logDuration),length.out=100)
durChaseMod_predict<-predicted_probs(ChaseMod, tmpdat, "logDuration",jvalues)

```

#### Checking assumptions

Let's also check some of the model assumptions and evaluate model fit. The generic model plot, with residuals vs fitted, won't actually tell us that much.

For inspiration on checking assumptions, I drew on the resources in [The Analysis Factor](https://www.theanalysisfactor.com/regression-diagnostics-glmm/) and [Statistical tools for high-throughput analysis](http://www.sthda.com/english/articles/36-classification-methods-essentials/148-logistic-regression-assumptions-and-diagnostics-in-r/).

**Random effects come from a normal distribution**

```{r randomeffects}
rands<-ranef(ChaseMod)

hist(c(rands$Trial[,1],rands$Time_of_Day[,1]))
```

This is not amazingly normal, but I think it's good enough, given that we have so few random effects estimates. 


**linearity of continuous predictor variables and logit of the outcome**

To evaluate this assumption, we need the predicted probabilities and the two continuous variables, group size and the log of bout duration.

```{r}
probabilities <- predict(ChaseMod, type="response")
pred_classes<-ifelse(probabilities > 0.5, "yes", "no")

predictors<-c("logDuration","Group_size","Time_of_Day","Trial")

mydata<-cbind(bout_data[,predictors], 
              logit=logit_transform(probabilities))

par(mfrow=c(1,2))
plot(mydata$logDuration~mydata$logit)
plot(mydata$Group_size~mydata$logit)


```

These look ok to me -- roughly linear.

**the variances of data (transformed by the link function) are homogeneous across categories**

This is similar -- we plot the predicted values across each of the categories and ensure similar variances.

```{r}
par(mfrow=c(1,2))
boxplot(mydata$logit~mydata$Trial)
boxplot(mydata$logit~mydata$Time_of_Day)
```

These also look ok, except maybe trial 10. And I think that the distributions within groups match the assumed distributions. 


**the chosen link function is appropriate**

To evaluate this, we can compare predicted values to actual outcomes -- but we'll need to round/subset/group the data to compare across continuous values.

```{r grpsizeLink}
grpSizes<-data.frame(
  avgChasing=unlist(as.list(by(bout_data,bout_data$Group_size, function(dat){
    return(mean(dat$Chasing_numeric))
  })))
)
grpSizes$grpSize <- rownames(grpSizes)

preds<-ChaseMod_predict[round(ChaseMod_predict$Variable,1) %in% grpSizes$grpSize,]
preds$Variable<-round(preds$Variable,1)

grpSizes<-merge(grpSizes, preds, by.x = "grpSize",by.y="Variable",all=TRUE)

plot(grpSizes$PredictedProbability~grpSizes$avgChasing)
```

There is a lot of variation with respect to group size in predicted probabilities when no chasing occurred (Fig. \@ref(fig: grpsizeLink)), but the non-zero probabilities appear fairly well correlated. The same appears to be true for bout duration (Fig. \@ref(fig: durationLink)). 

```{r durationLink}
durCats<-seq(floor(min(bout_data$logDuration)),ceiling(max(bout_data$logDuration)),by=0.5)

for(i in 1:length(durCats) - 1){
  boutDur[i,]<-data.frame(
    avgChasing=mean(bout_data$Chasing_numeric[bout_data$logDuration >= durCats[i] & 
                                                bout_data$logDuration < durCats[i+1]]),
    avgDur = mean(durCats[i], durCats[i+1]),
    predDur = mean(durChaseMod_predict$PredictedProbability[durChaseMod_predict$Variable >= durCats[i] &
                                                              durChaseMod_predict$Variable < durCats[i+1]])
  )
}


plot(boutDur$predDur~boutDur$avgChasing)
```


**Appropriate estimation of variance**

Based on Table \@ref(tab:ChasingMod), we can see that the parameter estimates have a reasonable amount of variation around them, which is a good indicator that the estimation of variance is appropriate. 

**No major outliers are present**

We can look at the distribution of residuals and see that they are reasonably normal (Fig. \@ref(fig:histResid)) -- on top of that, it is not highly skewed, with no obvious outliers. So I think we're probably good to proceed with interpreting this analysis!

```{r histResid}
hist(resid(ChaseMod))
```


### Bouts end in chasing

For this analysis, let's restrict it to those bouts that had some chasing in them. Since bouts without chasing are defined as also not ending in chasing, these are not useful pieces of data for this analysis. 

```{r chaseEndData}
chase_end_data<-bout_data[which(bout_data$Chasing_numeric==1),]
```


```{r EndMod}
EndMod<- glmer(Chasing_end_numeric~Group_size*logDuration+(1|Time_of_Day) +(1|Trial), 
                    family="binomial",
                    data=chase_end_data)
EndModSum<-summary(EndMod)
EndModAnova<-anova(EndMod)

# get standard errors
EndMod_SE <- sqrt(diag(vcov(EndMod)))

# convert to prob space
EndMod_Est<-cbind(Est = logit_back(fixef(EndMod)), 
              LL = logit_back(fixef(EndMod) - 1.96 * EndMod_SE), 
              UL = logit_back(fixef(EndMod) + 1.96 *EndMod_SE),
              EndModSum$coefficients[,3:4])


kable(EndMod_Est,"latex", booktab=TRUE)
```

In this case, none of the fixed effects in the model were significant (Table \@ref(tab:EndMod)). The probability that a bout would end in chasing, without any of the fixed effects, was `r round(EndMod_Est[1,1]*100,2)`%. 

As before, I created predicted probabilities based on the model to summarize the overall (lack of) effects, which were then useful for plotting (Fig. \@ref(fig:plotChasing)).

```{r grpEndModPredict}
tmpdat <- chase_end_data[, c("Group_size","logDuration", "Time_of_Day", "Trial")]

# group size
jvalues <- seq(from = min(chase_end_data$Group_size), to = max(chase_end_data$Group_size),length.out=100)
grpEndMod_predict<-predicted_probs(EndMod, tmpdat, "Group_size",jvalues)

#duration
jvalues <- seq(from = min(chase_end_data$logDuration), to = max(chase_end_data$logDuration),length.out=100)
durEndMod_predict<-predicted_probs(EndMod, tmpdat, "logDuration",jvalues)

```



### Chasing Plots (final)

```{r plotChasing, fig.height=7, fig.width=7, fig.cap="The probability of chasing occurring as a result of group size and duration. The bottom row plots the probability of a bout ending in chasing (given that it contained some chasing behaviour in the first place)."}
par(mfrow=c(2,2))
# group size
plot(jitter(bout_data$Chasing_numeric, 0.25)~bout_data$Group_size,
       pch=trial_pch[bout_data$Trial],
     col=alpha(time_cols[bout_data$Time_of_Day],0.5),
     cex=1.5,
     xlab="Mean Group size",
     ylab="Chasing present",
     yaxt='n',
     bty='l')
axis(2,at=c(0,1),labels=c("No","Yes"),las=1)

# add the predicted probabilities
polygon(c(rev(grpChaseMod_predict$Variable),grpChaseMod_predict$Variable), 
        c(rev(grpChaseMod_predict$Lower),grpChaseMod_predict$Upper),
     col = alpha("grey90",0.5), border = NA)

lines(grpChaseMod_predict$Variable, 
      grpChaseMod_predict$PredictedProbability, lwd = 2)

# duration
plot(jitter(bout_data$Chasing_numeric)~bout_data$logDuration,
     xlab="log(Courtship bout duration (s))",
     ylab="Chasing present",
     yaxt='n',
     bty='l',
     pch=19,
     col=alpha("dark grey",0.5),
     cex=1.5,
     type='n')
axis(2,at=c(0,1),labels=c("No","Yes"),las=1)


# add the predicted probabilities
polygon(c(rev(durChaseMod_predict$Variable),durChaseMod_predict$Variable), 
        c(rev(durChaseMod_predict$Lower),durChaseMod_predict$Upper),
     col = alpha("grey90",0.5), border = NA)

lines(durChaseMod_predict$Variable, 
      durChaseMod_predict$PredictedProbability, lwd = 2)

# add the points
points(jitter(bout_data$Chasing_numeric, 0.5)~bout_data$logDuration,
       pch=trial_pch[bout_data$Trial],
     col=alpha(time_cols[bout_data$Time_of_Day],0.5),
     cex=1.5)


par(mfrow=c(1,2))

# bout ended with chasing
plot(jitter(chase_end_data$Chasing_end_numeric,0.25)~chase_end_data$Group_size,
     xlab="Group size",
     ylab="Bout ended with Chasing",
     yaxt='n',
     bty='l',
     #type='n',
     pch=trial_pch[chase_end_data$Trial],
     col=alpha(time_cols[chase_end_data$Time_of_Day],0.5),
     cex=1.5)
axis(2,at=c(0,1),labels=c("No","Yes"),las=1)


# add the predicted probabilities
polygon(c(rev(grpEndMod_predict$Variable),grpEndMod_predict$Variable), 
        c(rev(grpEndMod_predict$Lower),grpEndMod_predict$Upper),
     col = alpha("grey90",0.5), border = NA)

lines(grpEndMod_predict$Variable, 
      grpEndMod_predict$PredictedProbability, lwd = 2)



# bout ended with chasing
plot(jitter(chase_end_data$Chasing_end_numeric,0.25)~chase_end_data$logDuration,
     xlab="log(Courtship bout duration (s))",
     ylab="Bout ended with Chasing",
     yaxt='n',
     bty='l',
     pch=trial_pch[chase_end_data$Trial],
     col=alpha(time_cols[chase_end_data$Time_of_Day],0.75),
     cex=1.5)
axis(2,at=c(0,1),labels=c("No","Yes"),las=1)

# add the predicted probabilities
polygon(c(rev(durEndMod_predict$Variable),durEndMod_predict$Variable), 
        c(rev(durEndMod_predict$Lower),durEndMod_predict$Upper),
     col = alpha("grey90",0.5), border = NA)

lines(durEndMod_predict$Variable, 
      durEndMod_predict$PredictedProbability, lwd = 2)


```



### Chasing and female size


```{r propChasingTrial}
# Calculating the proportion of chasing
prop_chasing <- table(chase_data$Trial, chase_data$Chasing_present )
prop_chasing <- as.data.frame(rbind(prop_chasing))
prop_chasing$No <- as.numeric(prop_chasing$No)
prop_chasing$Yes <- as.numeric(prop_chasing$Yes)
prop_chasing$sum <-prop_chasing$No + prop_chasing$Yes
prop_chasing$Prop_No <- round(prop_chasing$No/prop_chasing$sum, 3)
prop_chasing$Prop_Yes <- round(prop_chasing$Yes/prop_chasing$sum, 3)
prop_chasing$Trial <- rownames(prop_chasing)


prop_chase  <- merge(prop_chasing[,c(3:6)], 
                    unique(chase_data[,c("Trial", "Difference", "Max_length")]), 
                    by="Trial")

```

```{r plotLengthDistrs}
plot(prop_chase$Difference~prop_chase$Max_length,
     cex=1.5,     
     pch=19,
     xlab="Maximum female length (mm)",
     ylab="Difference in female lengths (mm)",
     bty='l',
     ylim=c(15,40),
     xlim=c(110,125))
```

Given that it seems that the maximum length and the difference in female sizes appear to be highly correlated (which makes some amount of sense; Fig. \@ref(fig:plotLengthDistrs)), we should only focus on one. Because Fleur collected some preliminary data suggesting that the relative size of prospective mates, not simply the raw size, is important in informing male decisions, we focused on the difference in body size. 

The best approach to analysing proportion data is to use a beta regression or a Dirchilet distribution ([Douma & Weedman 2019](https://doi.org/10.1111/2041-210X.13234)), but because these are trial-level estimates we don't really have enough data for an analysis of that sort (we have $N$=10). 

```{r propCor, warning=FALSE}
prop_cor<-cor.test(prop_chase$Prop_Yes, prop_chase$Difference,method = "spearman")
```


```{r plotPropChasingBodySize, fig.height=5, fig.width=5, fig.cap="The proportion of time spent chasing in a trial given the maximum difference in female lengths. The points are scaled by the number of bouts in that trial. While a positive trend is apparent from the plot, the correlation is not significant for this sample size of 10 trials."}
plot(prop_chase$Prop_Yes~prop_chase$Difference,
     cex=log(prop_chase$sum)/2,
     pch=19,
     xlab="Difference in female lengths (mm)",
     ylab="Proportion of time spent chasing",
     bty='l',
     ylim=c(0,1),
     xlim=c(15,40))
legend("topleft",
       bty='n',
       legend=c(bquote("Spearman's"~rho==.(round(prop_cor$estimate,3))),
                bquote("                   p"==.(round(prop_cor$p.value,3)))
                ),
       cex=1.5)
```

